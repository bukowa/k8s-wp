{{ $glob := . }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ include "wordpress.fullname" . }}-dpl"
spec:
  selector:
    matchLabels:
      app: "{{ include "wordpress.fullname" . }}"
  template:
    metadata:
      annotations:
        checksum/files: {{ join "," .Values.files | sha256sum }}
        checksum/plugins: {{ join "," .Values.plugins | sha256sum }}
        checksum/themes: {{ join "," .Values.themes | sha256sum }}
      labels:
        app: "{{ include "wordpress.fullname" . }}"
    spec:

      volumes:

        - name: "html"
          hostPath:
            path: /data/volumes/

        - name: "plugins"
          emptyDir: {}

        - name: "themes"
          emptyDir: {}

        {{ range $key, $value := .Values.files }}
        - name: {{ $key }}
          configMap:
            name: {{ include "wordpress.fullname" $glob }}-files
            defaultMode: {{ default "0444" $value.filemode }}
            items:
              - key: {{ $key }}
                path: {{ $key }}
        {{ end }}

      hostAliases:
        - ip: "127.0.0.1"
          hostnames:
            - mysql
            - wordpress
            - {{.Values.web.host}}

      initContainers:

      {{/*  ▒█▀▀█ ▒█░▒█ ▒█▀▀▀█ ▒█░░▒█ ▒█▄░▒█ ▒█▀▀█ ▒█▀▀▀ ▒█▀▀█ ▒█▀▀▀█ ▒█▀▀▀█*/}}
      {{/*  ▒█░░░ ▒█▀▀█ ▒█░░▒█ ▒█▒█▒█ ▒█▒█▒█ ▒█▄▄▀ ▒█▀▀▀ ▒█▄▄█ ▒█░░▒█ ░▀▀▀▄▄*/}}
      {{/*  ▒█▄▄█ ▒█░▒█ ▒█▄▄▄█ ▒█▄▀▄█ ▒█░░▀█ ▒█░▒█ ▒█▄▄▄ ▒█░░░ ▒█▄▄▄█ ▒█▄▄▄█*/}}
        - name: chownrepos
          image: busybox
          command: [ "/bin/sh", "-c"]
          args:
            - set -eux && chown -R 1588:1588 /repos/themes /repos/plugins
          volumeMounts:
            - mountPath: /repos/themes
              name: "themes"
            - mountPath: /repos/plugins
              name: "plugins"

      {{/*  ▒█▀▀█ ▀█▀ ▀▀█▀▀ ▒█▀▀█ ▒█░░░ ▒█▀▀▀█ ▒█▄░▒█ ▒█▀▀▀ ▒█▀▀█*/}}
      {{/*  ▒█░▄▄ ▒█░ ░▒█░░ ▒█░░░ ▒█░░░ ▒█░░▒█ ▒█▒█▒█ ▒█▀▀▀ ▒█▄▄▀*/}}
      {{/*  ▒█▄▄█ ▄█▄ ░▒█░░ ▒█▄▄█ ▒█▄▄█ ▒█▄▄▄█ ▒█░░▀█ ▒█▄▄▄ ▒█░▒█*/}}
        - name: gitcloner-themes
          image: bukowa/test:gitcloner
          securityContext:
            runAsGroup: 1588
            runAsUser: 1588
          imagePullPolicy: Always
          volumeMounts:
            - mountPath: /repos/themes
              name: "themes"
            - mountPath: /repos/plugins
              name: "plugins"
          args:
            - https://gitlab.com/bukowa/gitcloner-repotest-submodule

      containers:
      {{/*  ░█──░█ ░█▀▀▀█ ░█▀▀█ ░█▀▀▄ ░█▀▀█ ░█▀▀█ ░█▀▀▀ ░█▀▀▀█ ░█▀▀▀█*/}}
      {{/*  ░█░█░█ ░█──░█ ░█▄▄▀ ░█─░█ ░█▄▄█ ░█▄▄▀ ░█▀▀▀ ─▀▀▀▄▄ ─▀▀▀▄▄*/}}
      {{/*  ░█▄▀▄█ ░█▄▄▄█ ░█─░█ ░█▄▄▀ ░█─── ░█─░█ ░█▄▄▄ ░█▄▄▄█ ░█▄▄▄█*/}}
        - name: wordpress
          image: {{ .Values.image.wordpress }}
          ports:
            - containerPort: 80
              name: "wordpress"
          env:
            - name: WORDPRESS_DB_HOST
              value: mysql
            - name: WORDPRESS_DEBUG
              value: "1"
          envFrom:
            - secretRef:
                name: "{{ include "wordpress.fullname" . }}-database"

          volumeMounts:
            - mountPath: /var/www/html
              name: "html"
              subPath: {{ include "wordpress.fullname" . }}/var/www/html

            {{- template "file.volumes" (dict "Values" .Values "Container" "wordpress") }}

      {{/*  ▒█▀▀▄ ░█▀▀█ ▀▀█▀▀ ░█▀▀█ ▒█▀▀█ ░█▀▀█ ▒█▀▀▀█ ▒█▀▀▀*/}}
      {{/*  ▒█░▒█ ▒█▄▄█ ░▒█░░ ▒█▄▄█ ▒█▀▀▄ ▒█▄▄█ ░▀▀▀▄▄ ▒█▀▀▀*/}}
      {{/*  ▒█▄▄▀ ▒█░▒█ ░▒█░░ ▒█░▒█ ▒█▄▄█ ▒█░▒█ ▒█▄▄▄█ ▒█▄▄▄*/}}
        - name: database
          image: {{ .Values.image.mariadb }}
          ports:
            - containerPort: 3306
          env:
            - name: MARIADB_ROOT_HOST
              value: mysql

          envFrom:
            - secretRef:
                name: "{{ include "wordpress.fullname" . }}-database"

          volumeMounts:
            - mountPath: /var/lib/mysql/
              name: "html"
              subPath: {{ include "wordpress.fullname" . }}/var/lib/mysql/

            {{- template "file.volumes" (dict "Values" .Values "Container" "database") }}

      {{/*  ▒█░░▒█ ▒█▀▀█ ▒█▀▀█ ▒█░░░ ▀█▀*/}}
      {{/*  ▒█▒█▒█ ▒█▄▄█ ▒█░░░ ▒█░░░ ▒█░*/}}
      {{/*  ▒█▄▀▄█ ▒█░░░ ▒█▄▄█ ▒█▄▄█ ▄█▄*/}}
        - name: cli
          image: wordpress:cli-php7.4
          imagePullPolicy: Always
          securityContext:
            runAsGroup: 33
            runAsUser: 33
          command:
            - /bin/bash
            - -c
            - |
              set -eux
              /scripts/wait-for-entrypoint.sh -t 30 {{ .Values.web.url }}/wp-admin/install.php
              {{- range .Values.wordpress_start }}
                {{.}}
              {{- end }}
              if ! wp core is-installed;
              then
              {{- range .Values.wordpress_init }}
                {{.}}
              {{- end}}
              fi
              {{ range .Values.plugins }} wp plugin install --activate {{.}} &&
              {{- end }} sleep infinity

          volumeMounts:
            - mountPath: /var/www/html
              name: "html"
              subPath: {{ include "wordpress.fullname" . }}/var/www/html

            {{- template "file.volumes" (dict "Values" .Values "Container" "cli") }}

          envFrom:
            - secretRef:
                name: {{ include "wordpress.fullname" . }}-wordpress
            - secretRef:
                name: {{ include "wordpress.fullname" . }}-database

    {{/*  ▒█▀▀▀█ ▒█▀▀▀ ▀▀█▀▀ ▒█▀▀█*/}}
    {{/*  ░▀▀▀▄▄ ▒█▀▀▀ ░▒█░░ ▒█▄▄█*/}}
    {{/*  ▒█▄▄▄█ ▒█░░░ ░▒█░░ ▒█░░░*/}}
        {{ if .Values.ftp.enabled }}
        - name: sftp
          image: quay.io/wp-env/sftp:0.1.0
          imagePullPolicy: Always
          ports:
            - containerPort: 22
              name: "sftp"
          volumeMounts:
            - mountPath: "/home/{{.Values.ftp.login}}/html"
              name: "html"
              subPath: {{ include "wordpress.fullname" . }}/var/www/html
          args:
            - {{.Values.ftp.login}}:{{.Values.ftp.password}}:33
        {{ end }}
